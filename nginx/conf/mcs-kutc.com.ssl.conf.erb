# djangoコンテナへアクセスするための設定
upstream django {
    ip_hash;
    server django:8000;
}

# `https://mcs-kutc.com/`にアクセスされたときの設定
server {
    listen 443 ssl http2 default_server;
    server_name <%= domain.name %>;
    client_max_body_size 40M;  # 送受信できるファイルの大きさ．画像がアップロードできないと言われたらここの設定を変更，または画像を圧縮するように指示．


    # SSLの設定
    ssl_certificate <%= domain.chained_cert_path %>;
    ssl_certificate_key <%= domain.key_path %>;

    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache shared:SSL:50m;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    ssl_dhparam <%= dhparam_path %>;


    # gzipの設定
    gzip on;
    gzip_proxied any;
    gzip_min_length 1k;
    gzip_types text/plain
               text/css
               text/xml
               font/woff
               application/javascript
               application/rss+xml
               application/atom+xml
               application/manifest+json
               image/svg+xml
               image/postscript;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_static always;
    gunzip on;

    # etagを有効化
    etag on;


    # パスの割り当て
    location /static {
        alias /static;
        expires 30d;
        add_header X-Content-Type-Options nosniff;
        <%# 本番環境のとき，ヘッダーを追加 %>
        <% if ENV['STAGE'] == 'production' %>
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        <% end %>
    }

    location /media {
        alias /media;
        expires 30d;
        add_header X-Content-Type-Options nosniff;
        <% if ENV['STAGE'] == 'production' %>
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        <% end %>
    }

    location ^/hoge/.*\.html$ {
        alias /hoge;
        expires 1d;
        add_header X-Content-Type-Options nosniff;
        <% if ENV['STAGE'] == 'production' %>
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";
        <% end %>
    }
    location /hoge {
        alias /hoge;
        expires 1d;
        add_header X-Content-Type-Options nosniff;
        <% if ENV['STAGE'] == 'production' %>
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        <% end %>
    }

    # 上記の設定に当てはまらなかったときdjnagoに割り当て
    location / {
        include /etc/nginx/uwsgi_params;
        uwsgi_pass  django;
        uwsgi_read_timeout 300;
    }

    # エラーが発生したときはdjangoの404エラーページを表示
    error_page 403 404 500 503 =404 /404/;
}
